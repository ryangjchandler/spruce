{"version":3,"file":"spruce.umd.js","sources":["../src/index.js","../src/bus.js"],"sourcesContent":["import EventBus from './bus'\n\nconst Spruce = {\n    events: EventBus,\n\n    storesStack: {},\n\n    TARGET_ELEMENT_ID: '__spruce_store_target',\n\n    start() {\n        this.emit('beforeMount')\n            .insertTargetElementIfNotExists()\n            .setupMagicProp()\n            .emit('mounted')\n    },\n\n    insertTargetElementIfNotExists() {\n        if (this.targetElement()) {\n            return this\n        }\n\n        const el = document.createElement('div')\n\n        el.id = this.TARGET_ELEMENT_ID\n        el.setAttribute('x-data', '{ stores: {}, subscribers: [] }')\n\n        document.body.insertBefore(el, document.body.firstChild)\n\n        return this\n    },\n\n    setupMagicProp() {\n        if (! window.Alpine) {\n            throw new Error('[Spruce] Alpine >= 2.5.0 is required.')\n        }\n\n        window.Alpine.magicProperties['store'] = component => {\n            let subscribers = this.targetElement().__x.$data.subscribers\n\n            if (! subscribers.includes(component)) {\n                subscribers.push(component)\n            }\n\n            if (Object.keys(this.storesStack).length > 0) {\n                Object.entries(this.storesStack).forEach(([name, store]) => {\n                    this.targetElement().__x.$data.stores[name] = store\n                })\n\n                this.storesStack = {}\n            }\n\n            return this.stores()\n        }\n\n        return this\n    },\n\n    targetElement() {\n        return document.getElementById(this.TARGET_ELEMENT_ID)\n    },\n\n    stores() {\n        const target = this.targetElement()\n    \n        if (! target) {\n            return false\n        }\n\n        return target.__x.$data.stores\n    },\n\n    store(name, state, force = false) {\n        console.log(name)\n        if (this.storesStack[name] && ! force) {\n            return this.storesStack[name]\n        }\n\n        if (! this.targetElement()) {\n            this.storesStack[name] = state\n\n            return this.storesStack[name]\n        }\n\n        let stores = this.stores()\n\n        if (! stores[name] || this.force) {\n            stores[name] = state\n        }\n\n        return stores[name]\n    },\n\n    reset(name, state) {\n        this.store(name, state, true)\n    },\n\n    on(name, callback) {\n        return this.events.on(name, callback)\n    },\n\n    once(name, callback) {\n        return this.events.once(name, callback)\n    },\n\n    off(name, callback) {\n        this.events.off(name, callback)\n    },\n\n    emit(name, data = {}) {\n        this.events.emit(name, { ...data, store: this.stores })\n\n        return this\n    },\n\n    watch(target, callback) {\n        if (! target.startsWith('stores.')) {\n            target = `stores.${target}`\n        }\n\n        this.targetElement().__x.$data.$watch(target, callback)\n    }\n}\n\nconst deferrer = window.deferLoadingAlpine || (callback => callback())\n\nwindow.deferLoadingAlpine = function (callback) {\n    window.Spruce = Spruce\n    window.Spruce.start()\n\n    deferrer(callback)\n}\n\nexport default Spruce\n","export default {\n    events: {},\n\n    on(name, callback, once = false) {\n        if (! this.events[name]) {\n            this.events[name] = []\n        }\n\n        this.events[name].push({ callback, once })\n\n        return () => this.off(name, callback)\n    },\n\n    once(name, callback) {\n        this.on(name, callback, true)\n    },\n\n    off(name, callback) {\n        this.events[name] = this.events[name].filter(registerCallback => {\n            return registerCallback.callback !== callback && registerCallback.once !== true\n        })\n    },\n\n    emit(name, data = {}) {\n        if (this.events[name]) {\n            this.events[name].forEach(callback => {\n                callback.callback(data)\n\n                if (callback.once) {\n                    this.off(name, callback)\n                }\n            })\n        }\n\n        // TODO: deal with this for IE11 :(\n        // https://developer.mozilla.org/en-US/docs/Web/API/CustomEvent/CustomEvent#Browser_compatibility#Polyfill\n        window.dispatchEvent(new CustomEvent(`spruce:${name}`, {\n            detail: data,\n            bubbles: true\n        }))\n    }\n}"],"names":["Spruce","events","on","name","callback","once","this","push","off","filter","registerCallback","emit","data","forEach","window","dispatchEvent","CustomEvent","detail","bubbles","storesStack","TARGET_ELEMENT_ID","start","insertTargetElementIfNotExists","setupMagicProp","targetElement","el","document","createElement","id","setAttribute","body","insertBefore","firstChild","Alpine","Error","magicProperties","component","subscribers","__x","$data","includes","Object","keys","length","entries","stores","store","getElementById","target","state","force","console","log","reset","watch","startsWith","$watch","deferrer","deferLoadingAlpine"],"mappings":"6fAEMA,EAAS,CACXC,OCHW,CACXA,OAAQ,GAERC,YAAGC,EAAMC,EAAUC,qCAAO,GAChBC,KAAKL,OAAOE,UACTF,OAAOE,GAAQ,SAGnBF,OAAOE,GAAMI,KAAK,UAAEH,OAAUC,sBAEtBC,EAAKE,IAAIL,EAAMC,KAGhCC,cAAKF,EAAMC,QACFF,GAAGC,EAAMC,GAAU,IAG5BI,aAAIL,EAAMC,QACDH,OAAOE,GAAQG,KAAKL,OAAOE,GAAMM,gBAAOC,UAClCA,EAAiBN,WAAaA,IAAsC,IAA1BM,EAAiBL,QAI1EM,cAAKR,EAAMS,6BAAO,IACVN,KAAKL,OAAOE,SACPF,OAAOE,GAAMU,iBAAQT,GACtBA,EAASA,SAASQ,GAEdR,EAASC,QACJG,IAAIL,EAAMC,KAO3BU,OAAOC,cAAc,IAAIC,sBAAsBb,EAAQ,CACnDc,OAAQL,EACRM,SAAS,ODjCjBC,YAAa,GAEbC,kBAAmB,wBAEnBC,sBACSV,KAAK,eACLW,iCACAC,iBACAZ,KAAK,YAGdW,6CACQhB,KAAKkB,uBACElB,SAGLmB,EAAKC,SAASC,cAAc,cAElCF,EAAGG,GAAKtB,KAAKc,kBACbK,EAAGI,aAAa,SAAU,mCAE1BH,SAASI,KAAKC,aAAaN,EAAIC,SAASI,KAAKE,YAEtC1B,MAGXiB,yCACUT,OAAOmB,aACH,IAAIC,MAAM,gDAGpBpB,OAAOmB,OAAOE,gBAAd,eAAyCC,OACjCC,EAAc/B,EAAKkB,gBAAgBc,IAAIC,MAAMF,mBAE3CA,EAAYG,SAASJ,IACvBC,EAAY9B,KAAK6B,GAGjBK,OAAOC,KAAKpC,EAAKa,aAAawB,OAAS,IACvCF,OAAOG,QAAQtC,EAAKa,aAAaN,wCACxBW,gBAAgBc,IAAIC,MAAMM,OAAO1C,GAAQ2C,MAG7C3B,YAAc,IAGhBb,EAAKuC,UAGTvC,MAGXkB,gCACWE,SAASqB,eAAezC,KAAKc,oBAGxCyB,sBACUG,EAAS1C,KAAKkB,wBAEdwB,GAICA,EAAOV,IAAIC,MAAMM,QAG5BC,eAAM3C,EAAM8C,EAAOC,sBAAQ,GACvBC,QAAQC,IAAIjD,GACRG,KAAKa,YAAYhB,KAAW+C,SACrB5C,KAAKa,YAAYhB,OAGtBG,KAAKkB,4BACFL,YAAYhB,GAAQ8C,EAElB3C,KAAKa,YAAYhB,OAGxB0C,EAASvC,KAAKuC,gBAEZA,EAAO1C,KAASG,KAAK4C,QACvBL,EAAO1C,GAAQ8C,GAGZJ,EAAO1C,IAGlBkD,eAAMlD,EAAM8C,QACHH,MAAM3C,EAAM8C,GAAO,IAG5B/C,YAAGC,EAAMC,UACEE,KAAKL,OAAOC,GAAGC,EAAMC,IAGhCC,cAAKF,EAAMC,UACAE,KAAKL,OAAOI,KAAKF,EAAMC,IAGlCI,aAAIL,EAAMC,QACDH,OAAOO,IAAIL,EAAMC,IAG1BO,cAAKR,EAAMS,yBAAO,SACTX,OAAOU,KAAKR,iWAAWS,GAAMkC,MAAOxC,KAAKuC,UAEvCvC,MAGXgD,eAAMN,EAAQ5C,GACJ4C,EAAOO,WAAW,aACpBP,EAAU,UAASA,QAGlBxB,gBAAgBc,IAAIC,MAAMiB,OAAOR,EAAQ5C,KAIhDqD,EAAW3C,OAAO4C,6BAAuBtD,UAAYA,YAE3DU,OAAO4C,mBAAqB,SAAUtD,GAClCU,OAAOd,OAASA,EAChBc,OAAOd,OAAOqB,QAEdoC,EAASrD"}