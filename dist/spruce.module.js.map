{"version":3,"file":"spruce.module.js","sources":["../src/bus.js","../src/index.js"],"sourcesContent":["export default {\n    events: {},\n\n    on(name, callback, once = false) {\n        if (! this.events[name]) {\n            this.events[name] = []\n        }\n\n        this.events[name].push({ callback, once })\n\n        return () => this.off(name, callback)\n    },\n\n    once(name, callback) {\n        this.on(name, callback, true)\n    },\n\n    off(name, callback) {\n        this.events[name] = this.events[name].filter(registerCallback => {\n            return registerCallback.callback !== callback && registerCallback.once !== true\n        })\n    },\n\n    emit(name, data = {}) {\n        if (this.events[name]) {\n            this.events[name].forEach(callback => {\n                callback.callback(data)\n\n                if (callback.once) {\n                    this.off(name, callback)\n                }\n            })\n        }\n\n        // TODO: deal with this for IE11 :(\n        // https://developer.mozilla.org/en-US/docs/Web/API/CustomEvent/CustomEvent#Browser_compatibility#Polyfill\n        window.dispatchEvent(new CustomEvent(`spruce:${name}`, {\n            detail: data,\n            bubbles: true\n        }))\n    }\n}","import EventBus from './bus'\n\nconst Spruce = {\n    el: null,\n\n    events: EventBus,\n\n    storesStack: {},\n\n    start() {\n        this.guardAgainstAlpineMissing()\n\n        this.emit('beforeMount')\n            .insertTargetElementIfNotExists()\n            .setupMagicProp()\n            .emit('mounted')\n    },\n\n    guardAgainstAlpineMissing() {\n        if (!window.Alpine || window.Alpine.version < \"2.5.0\") {\n            throw new Error('[Spruce] Alpine v2.5.0 or greater is not installed');\n        }\n    },\n\n    insertTargetElementIfNotExists() {\n        const el = document.createElement('div')\n\n        el.setAttribute('x-data', '{ stores: {}, subscribers: [] }')\n\n        this.el = el\n\n        window.Alpine.initializeComponent(this.el)\n\n        return this\n    },\n\n    setupMagicProp() {\n        window.Alpine.addMagicProperty('store', component => {\n            let subscribers = this.el.__x.$data.subscribers\n\n            if (! subscribers.includes(component)) {\n                subscribers.push(component)\n            }\n\n            if (Object.keys(this.storesStack).length > 0) {\n                Object.entries(this.storesStack).forEach(([name, store]) => {\n                    this.el.__x.$data.stores[name] = store\n                })\n\n                this.storesStack = {}\n            }\n\n            return this.el.__x.$data.stores\n        })\n\n        return this\n    },\n\n    stores() {\n        return this.el.__x.$data.stores\n    },\n\n    store(name, state, force = false) {\n        if (this.storesStack[name] && !force) {\n            return this.storesStack[name]\n        }\n\n        if (! this.el) {\n            this.storesStack[name] = state\n\n            return this.storesStack[name]\n        }\n\n        let stores = this.stores()\n\n        if (!stores[name] || this.force) {\n            stores[name] = state\n        }\n\n        return stores[name]\n    },\n\n    reset(name, state) {\n        this.store(name, state, true)\n    },\n\n    on(name, callback) {\n        return this.events.on(name, callback)\n    },\n\n    once(name, callback) {\n        return this.events.once(name, callback)\n    },\n\n    off(name, callback) {\n        this.events.off(name, callback)\n    },\n\n    emit(name, data = {}) {\n        this.events.emit(name, { ...data, store: this.stores })\n\n        return this\n    },\n\n    watch(target, callback) {\n        if (!target.startsWith('stores.')) {\n            target = `stores.${target}`\n        }\n\n        this.el.__x.$data.$watch(target, callback)\n    }\n}\n\nconst deferrer = window.deferLoadingAlpine || (callback => callback())\n\nwindow.deferLoadingAlpine = function (callback) {\n    window.Spruce = Spruce\n    window.Spruce.start()\n\n    deferrer(callback)\n}\n\nexport default Spruce\n"],"names":["Spruce","el","events","on","name","callback","once","this","push","off","filter","registerCallback","emit","data","forEach","window","dispatchEvent","CustomEvent","detail","bubbles","storesStack","start","guardAgainstAlpineMissing","insertTargetElementIfNotExists","setupMagicProp","Alpine","version","Error","document","createElement","setAttribute","initializeComponent","addMagicProperty","component","subscribers","__x","$data","includes","Object","keys","length","entries","stores","store","state","force","reset","watch","target","startsWith","$watch","deferrer","deferLoadingAlpine"],"mappings":"oVAAA,ICEMA,EAAS,CACXC,GAAI,KAEJC,ODLW,CACXA,OAAQ,GAERC,YAAGC,EAAMC,EAAUC,qCAAO,GAChBC,KAAKL,OAAOE,UACTF,OAAOE,GAAQ,SAGnBF,OAAOE,GAAMI,KAAK,UAAEH,OAAUC,sBAEtBC,EAAKE,IAAIL,EAAMC,KAGhCC,cAAKF,EAAMC,QACFF,GAAGC,EAAMC,GAAU,IAG5BI,aAAIL,EAAMC,QACDH,OAAOE,GAAQG,KAAKL,OAAOE,GAAMM,gBAAOC,UAClCA,EAAiBN,WAAaA,IAAsC,IAA1BM,EAAiBL,QAI1EM,cAAKR,EAAMS,6BAAO,IACVN,KAAKL,OAAOE,SACPF,OAAOE,GAAMU,iBAAQT,GACtBA,EAASA,SAASQ,GAEdR,EAASC,QACJG,IAAIL,EAAMC,KAO3BU,OAAOC,cAAc,IAAIC,sBAAsBb,EAAQ,CACnDc,OAAQL,EACRM,SAAS,OC/BjBC,YAAa,GAEbC,sBACSC,iCAEAV,KAAK,eACLW,iCACAC,iBACAZ,KAAK,YAGdU,yCACSP,OAAOU,QAAUV,OAAOU,OAAOC,QAAU,cACpC,IAAIC,MAAM,uDAIxBJ,8CACUtB,EAAK2B,SAASC,cAAc,cAElC5B,EAAG6B,aAAa,SAAU,wCAErB7B,GAAKA,EAEVc,OAAOU,OAAOM,oBAAoBxB,KAAKN,IAEhCM,MAGXiB,4CACIT,OAAOU,OAAOO,iBAAiB,iBAASC,OAChCC,EAAc3B,EAAKN,GAAGkC,IAAIC,MAAMF,mBAE9BA,EAAYG,SAASJ,IACvBC,EAAY1B,KAAKyB,GAGjBK,OAAOC,KAAKhC,EAAKa,aAAaoB,OAAS,IACvCF,OAAOG,QAAQlC,EAAKa,aAAaN,sBACxBb,GAAGkC,IAAIC,MAAMM,sBAGjBtB,YAAc,IAGhBb,EAAKN,GAAGkC,IAAIC,MAAMM,SAGtBnC,MAGXmC,yBACWnC,KAAKN,GAAGkC,IAAIC,MAAMM,QAG7BC,eAAMvC,EAAMwC,EAAOC,sBAAQ,GACnBtC,KAAKa,YAAYhB,KAAUyC,SACpBtC,KAAKa,YAAYhB,OAGtBG,KAAKN,eACFmB,YAAYhB,GAAQwC,EAElBrC,KAAKa,YAAYhB,OAGxBsC,EAASnC,KAAKmC,gBAEbA,EAAOtC,KAASG,KAAKsC,QACtBH,EAAOtC,GAAQwC,GAGZF,EAAOtC,IAGlB0C,eAAM1C,EAAMwC,QACHD,MAAMvC,EAAMwC,GAAO,IAG5BzC,YAAGC,EAAMC,UACEE,KAAKL,OAAOC,GAAGC,EAAMC,IAGhCC,cAAKF,EAAMC,UACAE,KAAKL,OAAOI,KAAKF,EAAMC,IAGlCI,aAAIL,EAAMC,QACDH,OAAOO,IAAIL,EAAMC,IAG1BO,cAAKR,EAAMS,yBAAO,SACTX,OAAOU,KAAKR,iWAAWS,GAAM8B,MAAOpC,KAAKmC,UAEvCnC,MAGXwC,eAAMC,EAAQ3C,GACL2C,EAAOC,WAAW,aACnBD,EAAU,UAASA,QAGlB/C,GAAGkC,IAAIC,MAAMc,OAAOF,EAAQ3C,KAInC8C,EAAWpC,OAAOqC,6BAAuB/C,UAAYA,KAE3DU,OAAOqC,mBAAqB,SAAU/C,GAClCU,OAAOf,OAASA,EAChBe,OAAOf,OAAOqB,QAEd8B,EAAS9C"}